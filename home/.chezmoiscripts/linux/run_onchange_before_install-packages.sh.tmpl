{{ if eq .osid "linux-debian" "linux-raspbian" "linux-ubuntu" "linux-linuxmint" -}}

{{ $packages := list
    "bat"
    "build-essential"
    "curl"
    "direnv"
    "emacs"
    "exa"
    "fd-find"
    "fzf"
    "git"
    "git-lfs"
    "jq"
    "libfuse2"
    "ripgrep"
    "shellcheck"
    "units"
    "zsh"
    "zoxide" -}}

{{ if eq .osid "linux-ubuntu" "linux-linuxmint" -}}
  {{   $packages = mustAppend $packages "btop" -}}
{{ end -}}

{{ if not .headless -}}
  {{   $packages = mustAppend $packages "xclip" -}}
{{ end -}}

{{ if .personal -}}
  {{   $packages = mustAppend $packages 
    "openssh-server" 
  -}}
{{ end -}}

{{ $snaps := list -}}
{{ $classicSnaps := list -}}

{{ if (and (.personal) (not .headless)) -}}
  
{{   $snaps = concat $snaps (list 
  "1password"
  "dbeaver-ce"
  "obs-studio"
  ) 
-}}

{{   $classicSnaps = concat $classicSnaps (list 
  "code" 
  "gitkraken" 
  "snapcraft"
  ) 
-}}

{{ end -}}


{{ $sudo := "sudo " -}}
{{ if eq .chezmoi.username "root" -}}
  {{   $sudo = "" -}}
{{ end -}}

#!/bin/bash

set -euo pipefail

echo --- Deb Packages: {{ $packages }} ---

{{ $sudo }}apt-get update
{{ $sudo }}apt-get install -y {{ $packages | join " " }}

echo --- Snaps: {{ $snaps }} ---
echo --- Classic Snaps: {{ $classicSnaps }} ---

{{ if lookPath "snap" }}
{{   range $snaps }}
( snap info {{ . }} | grep -q ^installed: ) || {{ $sudo }}snap install {{ . }}
{{   end }}
{{   range $classicSnaps }}
( snap info {{ . }} | grep -q ^installed: ) || {{ $sudo }}snap install --classic {{ . }}
{{   end }}
{{ end }}

{{ if eq .osid "linux-linuxmint" -}}
# Mint does not by default add the Snap icons to the menu, hece we need to copy them
cp /var/lib/snapd/desktop/applications/*.desktop {{ .chezmoi.homeDir }}/.local/share/applications
{{- end }}

{{ end }}
